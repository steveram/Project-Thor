<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
  <title>Tweet Clustering</title>
  <style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0px; padding: 0px }
  #cm-example { height: 100% }
</style>
    <script type="text/javascript" src="http://tile.cloudmade.com/wml/latest/web-maps-lite.js"></script>
    <script type = "text/javascript" src = "https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
    <script type = "text/javascript">
    var swLat, swLng, neLat, neLng, sw, ne, map, clusterer, markers, CloudMadeIcon, redIcon, CLUSTER_LOCATIONS = [];

    function initialize(){
        var cloudmade = new CM.Tiles.CloudMade.Web({key: 'BC9A493B41014CAABB98F0471D759707', styleId:999});
        map = new CM.Map('cm-example', cloudmade);
        
            CloudMadeIcon = new CM.Icon();
            CloudMadeIcon.image = "images/tweet.png";
            CloudMadeIcon.iconSize = new CM.Size(32, 32);
            CloudMadeIcon.iconAnchor = new CM.Point(0, 0);
            
            redIcon = new CM.Icon();
            redIcon.image = "images/red.gif";
            redIcon.iconSize = new CM.Size(10, 10);
            redIcon.iconAnchor = new CM.Point(0, 0);

        if(navigator.geolocation) {
                browserSupportFlag = true;
                navigator.geolocation.getCurrentPosition(function(position) {
                   initialLocation = new CM.LatLng(position.coords.latitude,position.coords.longitude);
                map.setCenter(initialLocation, 10);
                map.addControl(new CM.LargeMapControl());
                map.addControl(new CM.ScaleControl());
                map.addControl(new CM.OverviewMapControl());
                bounds = map.getBounds();
                sw = bounds.getSouthWest();
                ne = bounds.getNorthEast();
            }, function() {

            });
        }
        
        CM.Event.addListener(map, 'moveend', function(latlng) {
             $(".wml-marker-pane").html("");
             if(clusterer){
                clusterer._clusters = {};
                clusterer.addMarkers([]);
             }
              bounds = map.getBounds();
              sw = bounds.getSouthWest();
              ne = bounds.getNorthEast();
              getHotSpots();        
          });
          
    }
    
    
    function getHotSpots(){
        markers = [];
        var marker;
        $.get("/hotspots", {swLat: sw.lat(), swLng: sw.lng(), neLat : ne.lat(), neLng: ne.lng()}, function(response){
            for(var i in response.data){
                markers.push(new CM.Marker(new CM.LatLng(response.data[i].loc.lat, response.data[i].loc.long), {icon: CloudMadeIcon}));
                //map.addOverlay(new CM.Marker(new CM.LatLng(response[i].loc.lat, response[i].loc.long), {icon : redIcon}));
              }
              clusterer = new CM.MarkerClusterer(map, {clusterRadius: 70});
              clusterer.addMarkers(markers);
        });
    }
    
    /**
        This updates the global CLUSTER_LOCATIONS which holds an array of
        Cluster objects. Can be used to find POIs around each cluster
    */
    function getClusterLocations(){
        if(!clusterer) return;
        CLUSTER_LOCATIONS = [];
        for(var i in clusterer._clusters){
            var cluster = {
                lat: clusterer._clusters[i]._center._lat,
                lng: clusterer._clusters[i]._center._lng,
                numTweets: clusterer._clusters[i]._prevLen,
                zoomLevel : clusterer._clusters[i]._zoom
            }
            CLUSTER_LOCATIONS.push(cluster);
        }
    }
    </script>
</head>
<body>

  <div id="cm-example" style=""></div>
  <script type="text/javascript">
    $(document).ready(function(){
        initialize();
    });
  </script>
</body>
</html>
  
